<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Low Poly Forest Survival</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
        
        /* UI Layer */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #hud-top {
            position: absolute; top: 20px; left: 20px;
            color: #fff; font-size: 18px; font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px;
        }

        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 6px; height: 6px; background: #0f0;
            border-radius: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 4px #0f0;
        }

        /* Boss Bar */
        #boss-container {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 500px; height: 30px; background: #222; border: 3px solid #000;
            display: none; border-radius: 15px; overflow: hidden;
        }
        #boss-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #800, #f00); transition: width 0.2s; }
        #boss-text { position: absolute; width: 100%; text-align: center; color: white; line-height: 30px; font-weight: 800; letter-spacing: 2px; text-shadow: 1px 1px 2px black; }

        /* Shop */
        #shop-menu {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(20, 20, 30, 0.95); border: 2px solid #44aaff;
            padding: 30px; color: white; display: none; pointer-events: auto;
            text-align: center; border-radius: 10px; box-shadow: 0 0 20px rgba(68, 170, 255, 0.5);
        }
        .shop-btn {
            display: block; width: 300px; padding: 15px; margin: 10px;
            background: #333; border: 1px solid #555; color: #fff; cursor: pointer;
            transition: 0.3s; font-size: 16px;
        }
        .shop-btn:hover { background: #44aaff; color: #000; }

        /* Start Screen */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; pointer-events: auto;
        }
        h1 { font-size: 60px; margin: 0; color: #e74c3c; text-shadow: 0 0 10px #c0392b; }
        .key { background: #444; padding: 2px 6px; border-radius: 4px; border: 1px solid #777; }
        
        #msg-overlay {
            position: absolute; top: 30%; width: 100%; text-align: center;
            font-size: 40px; color: yellow; font-weight: bold; text-shadow: 0 0 10px red;
            opacity: 0; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="hud-top">
            HEALTH: <span id="hp-display" style="color:#e74c3c">100</span><br>
            CASH: $<span id="money-display" style="color:#f1c40f">0</span><br>
            WEAPON: <span id="weapon-display">RIFLE</span>
        </div>
        <div id="boss-container">
            <div id="boss-text">☠️ FOREST DEMON ☠️</div>
            <div id="boss-fill"></div>
        </div>
        <div id="crosshair"></div>
        <div id="msg-overlay"></div>
    </div>

    <div id="shop-menu">
        <h2 style="margin-top:0">WEAPONRY</h2>
        <div class="shop-btn" onclick="buyWeapon('MACHINE_GUN', 800)">M249 MACHINE GUN ($800)</div>
        <div class="shop-btn" onclick="buyWeapon('RPG', 1500)">RPG LAUNCHER ($1500)</div>
        <div class="shop-btn" onclick="closeShop()">CLOSE SHOP (Press B)</div>
    </div>

    <div id="start-screen">
        <h1>FOREST SURVIVAL</h1>
        <p>Defeat Zombies, Earn Cash, Kill the Demon.</p>
        <p><span class="key">WASD</span> Move &nbsp; <span class="key">CLICK</span> Shoot &nbsp; <span class="key">B</span> Shop</p>
        <p style="margin-top:20px; font-size: 24px; color: #44aaff; cursor: pointer; border-bottom: 2px solid #44aaff;" onclick="startGame()">CLICK TO START</span></p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            zombieSpeed: 12,
            zombieHp: 60,
            bossHp: 3000,
            gravity: 400,
            jumpForce: 150
        };

        // --- GLOBAL VARIABLES ---
        let camera, scene, renderer;
        let player = { hp: 100, money: 0, weapon: 'RIFLE', canShoot: true };
        let controls = { forward: false, backward: false, left: false, right: false, canJump: false };
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let prevTime = performance.now();
        
        let gameActive = false;
        let isShopOpen = false;
        
        // Entities
        let zombies = [];
        let bullets = [];
        let trees = [];
        let boss = null;
        let gunMesh = null;
        let muzzleLight = null;
        let moonMesh = null;
        let groundMesh = null;
        
        // Game State
        let bossSpawned = false;
        let spacePhase = false;
        let finalPhase = false;

        const WEAPONS = {
            'RIFLE': { dmg: 25, rate: 150, color: 0xffff00, scale: 1 },
            'MACHINE_GUN': { dmg: 15, rate: 60, color: 0xffaa00, scale: 1.2 },
            'RPG': { dmg: 150, rate: 1200, color: 0xff0000, scale: 2, explosive: true },
            'MOONBLADE': { dmg: 80, rate: 200, color: 0x00ffff, scale: 1 }, // Space weapon
            'AXE': { dmg: 500, rate: 600, range: 6, melee: true } // Finisher
        };
        let lastShot = 0;

        // --- INIT ---
        function init() {
            // Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // Sky Blue
            scene.fog = new THREE.Fog(0x87CEEB, 0, 150);

            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 5;

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Lights
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
            scene.add(hemiLight);
            
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 100, 50);
            dirLight.castShadow = true;
            dirLight.shadow.camera.top = 50;
            dirLight.shadow.camera.bottom = -50;
            dirLight.shadow.camera.left = -50;
            dirLight.shadow.camera.right = 50;
            scene.add(dirLight);

            // Environment: Forest
            createEnvironment();

            // Player Gun Model
            createPlayerGun();

            // Events
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousedown', onMouseDown);
            window.addEventListener('resize', onResize);

            // Game Loop
            animate();
            
            // Spawner
            setInterval(() => {
                if (gameActive && !bossSpawned && zombies.length < 15) spawnZombie();
            }, 1500);
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.body.requestPointerLock();
            gameActive = true;
        }

        // --- ENVIRONMENT GENERATION ---
        function createEnvironment() {
            // Ground
            const groundGeo = new THREE.PlaneGeometry(1000, 1000);
            groundGeo.rotateX(-Math.PI / 2);
            const groundMat = new THREE.MeshStandardMaterial({ color: 0x2d5a27 }); // Forest Green
            groundMesh = new THREE.Mesh(groundGeo, groundMat);
            groundMesh.receiveShadow = true;
            scene.add(groundMesh);

            // Trees (Procedural)
            const trunkGeo = new THREE.CylinderGeometry(0.5, 0.8, 4, 6);
            const trunkMat = new THREE.MeshStandardMaterial({ color: 0x5c4033 });
            const leavesGeo = new THREE.ConeGeometry(3, 8, 8);
            const leavesMat = new THREE.MeshStandardMaterial({ color: 0x1a472a });

            for (let i = 0; i < 150; i++) {
                const tree = new THREE.Group();
                
                const trunk = new THREE.Mesh(trunkGeo, trunkMat);
                trunk.position.y = 2;
                trunk.castShadow = true;
                
                const leaves = new THREE.Mesh(leavesGeo, leavesMat);
                leaves.position.y = 6;
                leaves.castShadow = true;

                tree.add(trunk);
                tree.add(leaves);

                // Random Position (avoid center spawn)
                let x = (Math.random() - 0.5) * 400;
                let z = (Math.random() - 0.5) * 400;
                if (Math.abs(x) < 20 && Math.abs(z) < 20) x += 30; // Push away from spawn

                tree.position.set(x, 0, z);
                
                // Random Scale
                const s = 0.8 + Math.random() * 0.6;
                tree.scale.set(s, s, s);

                scene.add(tree);
                trees.push(tree);
            }

            // Moon (Hidden initially)
            const moonGeo = new THREE.SphereGeometry(40, 32, 32);
            const moonMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
            moonMesh = new THREE.Mesh(moonGeo, moonMat);
            moonMesh.position.set(0, 300, -400);
            scene.add(moonMesh);
        }

        function createPlayerGun() {
            gunMesh = new THREE.Group();
            
            // Gun Body
            const bodyGeo = new THREE.BoxGeometry(0.2, 0.2, 0.8);
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            
            // Magazine
            const magGeo = new THREE.BoxGeometry(0.1, 0.3, 0.15);
            const mag = new THREE.Mesh(magGeo, bodyMat);
            mag.position.set(0, -0.2, 0);

            gunMesh.add(body);
            gunMesh.add(mag);
            
            // Position relative to camera
            gunMesh.position.set(0.3, -0.25, -0.5);
            camera.add(gunMesh);

            // Muzzle Flash Light
            muzzleLight = new THREE.PointLight(0xffaa00, 0, 5);
            muzzleLight.position.set(0, 0, -0.6);
            gunMesh.add(muzzleLight);
        }

        // --- CHARACTERS ---
        function spawnZombie() {
            const zombieGroup = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color: 0x2e8b57 }); // Zombie Skin
            const clothesMat = new THREE.MeshStandardMaterial({ color: 0x3b3b3b });

            // Head
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), mat);
            head.position.y = 2.8;
            
            // Body
            const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.2, 0.5), clothesMat);
            body.position.y = 1.8;

            // Arms
            const armGeo = new THREE.BoxGeometry(0.3, 1, 0.3);
            const leftArm = new THREE.Mesh(armGeo, mat);
            leftArm.position.set(-0.7, 2, 0.4);
            leftArm.rotation.x = -Math.PI / 2; // Arms out
            
            const rightArm = new THREE.Mesh(armGeo, mat);
            rightArm.position.set(0.7, 2, 0.4);
            rightArm.rotation.x = -Math.PI / 2;

            zombieGroup.add(head, body, leftArm, rightArm);
            
            // Random Spawn
            const angle = Math.random() * Math.PI * 2;
            const dist = 40 + Math.random() * 40;
            zombieGroup.position.set(
                camera.position.x + Math.cos(angle) * dist,
                0,
                camera.position.z + Math.sin(angle) * dist
            );

            scene.add(zombieGroup);
            zombies.push({ mesh: zombieGroup, hp: CONFIG.zombieHp });
        }

        function spawnBoss() {
            bossSpawned = true;
            document.getElementById('boss-container').style.display = 'block';
            showMsg("THE DEMON HAS AWAKENED!");

            const bossGroup = new THREE.Group();
            const skinMat = new THREE.MeshStandardMaterial({ color: 0x800000, roughness: 0.2 });
            
            // Big Body
            const body = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 3), skinMat);
            body.position.y = 6;
            
            // Big Head with Horns
            const head = new THREE.Mesh(new THREE.BoxGeometry(2.5, 2.5, 2.5), skinMat);
            head.position.y = 10;
            
            const hornGeo = new THREE.ConeGeometry(0.3, 2, 8);
            const horn1 = new THREE.Mesh(hornGeo, new THREE.MeshStandardMaterial({color:0x000}));
            horn1.position.set(0.8, 1.5, 0);
            horn1.rotation.z = -0.3;
            const horn2 = horn1.clone();
            horn2.position.set(-0.8, 1.5, 0);
            horn2.rotation.z = 0.3;
            head.add(horn1, horn2);

            bossGroup.add(body, head);
            bossGroup.position.set(0, 0, -80);
            
            scene.add(bossGroup);
            boss = { mesh: bossGroup, hp: CONFIG.bossHp, maxHp: CONFIG.bossHp };
        }

        // --- GAMEPLAY LOGIC ---

        function shoot() {
            const now = performance.now();
            const w = WEAPONS[player.weapon];
            if (now - lastShot < w.rate) return;
            lastShot = now;

            // Visuals
            muzzleLight.intensity = 2;
            setTimeout(() => muzzleLight.intensity = 0, 50);
            
            // Recoil Animation
            gunMesh.position.z += 0.1;
            setTimeout(() => gunMesh.position.z -= 0.1, 100);

            // Melee Logic
            if (w.melee) {
                if (boss && boss.mesh.position.distanceTo(camera.position) < 15) {
                    damageBoss(w.dmg);
                }
                return;
            }

            // Raycast / Projectile Logic
            const bullet = new THREE.Mesh(
                new THREE.BoxGeometry(0.1, 0.1, 1),
                new THREE.MeshBasicMaterial({ color: w.color })
            );
            bullet.position.copy(camera.position);
            bullet.quaternion.copy(camera.quaternion);
            bullet.translateZ(-1); // Start slightly in front
            
            const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            bullet.userData = { velocity: dir.multiplyScalar(300), type: player.weapon };
            
            scene.add(bullet);
            bullets.push(bullet);
        }

        function damageBoss(amount) {
            if (!boss) return;
            if (finalPhase && player.weapon !== 'AXE') {
                showMsg("GUNS DON'T WORK! USE THE AXE!");
                return;
            }

            boss.hp -= amount;
            const pct = (boss.hp / boss.maxHp) * 100;
            document.getElementById('boss-fill').style.width = pct + '%';

            // Flash Boss
            boss.mesh.children.forEach(c => c.material.emissive = new THREE.Color(0xff0000));
            setTimeout(() => boss.mesh.children.forEach(c => c.material.emissive = new THREE.Color(0x000000)), 100);

            // Phase 2: Space
            if (!spacePhase && boss.hp < boss.maxHp * 0.5) {
                enterSpacePhase();
            }

            // Death
            if (boss.hp <= 0) {
                boss.mesh.visible = false;
                boss = null;
                showMsg("VICTORY! DEMON SLAIN!");
                setTimeout(() => location.reload(), 3000);
            }
        }

        function enterSpacePhase() {
            spacePhase = true;
            showMsg("GRAVITY SHIFT DETECTED! TELEPORTING...");
            
            // Change Environment
            scene.background = new THREE.Color(0x000011); // Space Black
            scene.fog = new THREE.Fog(0x000011, 0, 500);
            groundMesh.material.color.setHex(0x555555); // Moon Grey
            
            // Remove Trees
            trees.forEach(t => t.visible = false);
            
            // Boss Flies
            boss.mesh.position.y = 40;
            
            // Give Weapon
            player.weapon = 'MOONBLADE';
            updateHUD();
            
            // Physics change
            CONFIG.gravity = 100; // Low gravity
            CONFIG.jumpForce = 100;
            camera.position.y = 20;
        }

        function triggerFinalPhase() {
            if (finalPhase) return;
            finalPhase = true;
            moonMesh.material.color.setHex(0xff0000); // Blood Moon
            showMsg("MOON SHATTERED! USE THE AXE TO FINISH HIM!");
            player.weapon = 'AXE';
            updateHUD();
        }

        function updateHUD() {
            document.getElementById('hp-display').innerText = Math.floor(player.hp);
            document.getElementById('money-display').innerText = player.money;
            document.getElementById('weapon-display').innerText = player.weapon.replace('_', ' ');
        }

        function showMsg(text) {
            const el = document.getElementById('msg-overlay');
            el.innerText = text;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 3000);
        }

        // --- CONTROLS ---
        function onKeyDown(e) {
            switch(e.code) {
                case 'KeyW': controls.forward = true; break;
                case 'KeyS': controls.backward = true; break;
                case 'KeyA': controls.left = true; break;
                case 'KeyD': controls.right = true; break;
                case 'Space': if(controls.canJump) { velocity.y += CONFIG.jumpForce; controls.canJump = false; } break;
                case 'KeyB': toggleShop(); break;
            }
        }
        function onKeyUp(e) {
            switch(e.code) {
                case 'KeyW': controls.forward = false; break;
                case 'KeyS': controls.backward = false; break;
                case 'KeyA': controls.left = false; break;
                case 'KeyD': controls.right = false; break;
            }
        }
        function onMouseDown() {
            if (!gameActive) return;
            if (isShopOpen) return;
            if (document.pointerLockElement !== document.body) {
                document.body.requestPointerLock();
            } else {
                shoot();
            }
        }

        function toggleShop() {
            isShopOpen = !isShopOpen;
            const shop = document.getElementById('shop-menu');
            if (isShopOpen) {
                document.exitPointerLock();
                shop.style.display = 'block';
            } else {
                document.body.requestPointerLock();
                shop.style.display = 'none';
            }
        }

        window.buyWeapon = function(name, cost) {
            if (player.money >= cost) {
                player.money -= cost;
                player.weapon = name;
                updateHUD();
                alert("Bought " + name);
            } else {
                alert("Need more cash!");
            }
        };
        window.closeShop = function() { toggleShop(); };

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- MAIN LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            if (!gameActive) return;

            const time = performance.now();
            const delta = (time - prevTime) / 1000;
            prevTime = time;

            // 1. Physics (Simple FPS Controller)
            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;
            velocity.y -= CONFIG.gravity * delta; // Gravity

            direction.z = Number(controls.forward) - Number(controls.backward);
            direction.x = Number(controls.right) - Number(controls.left);
            direction.normalize();

            if (controls.forward || controls.backward) velocity.z -= direction.z * 600.0 * delta;
            if (controls.left || controls.right) velocity.x -= direction.x * 600.0 * delta;

            controls.canJump = false;
            camera.translateX(-velocity.x * delta);
            camera.translateZ(-velocity.z * delta);
            camera.position.y += velocity.y * delta;

            if (camera.position.y < 5) {
                velocity.y = 0;
                camera.position.y = 5;
                controls.canJump = true;
            }

            // 2. Zombies
            zombies.forEach((z, idx) => {
                const dist = z.mesh.position.distanceTo(camera.position);
                z.mesh.lookAt(camera.position.x, 0, camera.position.z);
                
                if (dist > 2) {
                    z.mesh.translateZ(CONFIG.zombieSpeed * delta);
                } else {
                    // Attack
                    player.hp -= 0.5;
                    updateHUD();
                    if (player.hp <= 0) {
                        alert("YOU DIED");
                        location.reload();
                    }
                }
            });

            // 3. Bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i];
                b.position.add(b.userData.velocity.clone().multiplyScalar(delta));

                let hit = false;
                
                // Hit Moon (Trigger Final Phase)
                if (spacePhase && !finalPhase && b.position.distanceTo(moonMesh.position) < 50) {
                    triggerFinalPhase();
                    hit = true;
                }

                // Hit Zombies
                if (!hit) {
                    for (let j = zombies.length - 1; j >= 0; j--) {
                        if (b.position.distanceTo(zombies[j].mesh.position) < 3) {
                            zombies[j].hp -= WEAPONS[b.userData.type].dmg;
                            // Knockback
                            zombies[j].mesh.translateZ(-2);
                            
                            if (zombies[j].hp <= 0) {
                                scene.remove(zombies[j].mesh);
                                zombies.splice(j, 1);
                                player.money += 150;
                                updateHUD();
                                
                                // Boss Trigger
                                if (player.money >= 1000 && !bossSpawned) spawnBoss();
                            }
                            hit = true;
                            break;
                        }
                    }
                }

                // Hit Boss
                if (!hit && boss && b.position.distanceTo(boss.mesh.position) < 10) {
                    damageBoss(WEAPONS[b.userData.type].dmg);
                    hit = true;
                }

                if (hit || b.position.distanceTo(camera.position) > 300) {
                    scene.remove(b);
                    bullets.splice(i, 1);
                }
            }

            // 4. Boss Movement
            if (boss) {
                boss.mesh.lookAt(camera.position);
                if (!spacePhase) {
                    if (boss.mesh.position.distanceTo(camera.position) > 10) {
                        boss.mesh.translateZ(15 * delta);
                    }
                } else {
                    // Hover in space
                    boss.mesh.position.y = 30 + Math.sin(time * 0.002) * 10;
                }
            }

            renderer.render(scene, camera);
        }

        // Start
        init();

    </script>
</body>
</html>